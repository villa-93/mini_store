<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Mini Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo">
                <span class="logo-icon">‚ö°</span>
                Mini Store
            </a>
            <ul class="nav-links">
                <li><a href="index.html">üè† Inicio</a></li>
                <li><a href="perfil.html">üë§ Perfil</a></li>
                <li><a href="pedidos.html">üì¶ Mis Pedidos</a></li>
                <li>
                    <a href="carrito.html">
                        üõí Carrito
                        <span class="cart-badge" id="cartCount">0</span>
                    </a>
                </li>
                <li><a href="#" id="btnLogout">üö™ Salir</a></li>
            </ul>
        </div>
    </nav>

    <!-- Contenido -->
    <div class="container">
        <h1 style="color: var(--dark); margin-bottom: 2rem;">üõí Carrito de Compras</h1>

        <div id="alert-container"></div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <!-- Items del Carrito -->
            <div>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                </div>

                <div id="carritoVacio" style="display: none; text-align: center; padding: 3rem;">
                    <div style="font-size: 5rem; margin-bottom: 1rem;">üõí</div>
                    <h3>Tu carrito est√° vac√≠o</h3>
                    <p class="text-muted mb-3">Agrega productos desde la tienda</p>
                    <a href="index.html" class="btn btn-primary">Ver Productos</a>
                </div>

                <div id="carritoItems">
                    <!-- Items se cargar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Resumen del Pedido -->
            <div>
                <div class="card" style="position: sticky; top: 100px;">
                    <h3 style="color: var(--dark); margin-bottom: 1.5rem;">üìã Resumen del Pedido</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <div class="flex-between mb-2">
                            <span class="text-muted">Subtotal:</span>
                            <span style="font-weight: 600;">$<span id="subtotal">0</span></span>
                        </div>
                        <div class="flex-between mb-2">
                            <span class="text-muted">Env√≠o:</span>
                            <span style="font-weight: 600; color: var(--success);">Gratis</span>
                        </div>
                        <hr style="margin: 1rem 0; border: none; border-top: 2px solid #e5e7eb;">
                        <div class="flex-between">
                            <span style="font-weight: 700; font-size: 1.2rem;">Total:</span>
                            <span style="font-weight: 700; font-size: 1.5rem; color: var(--primary);">$<span id="total">0</span></span>
                        </div>
                    </div>

                    <button id="btnProcederPago" class="btn btn-primary btn-block" style="display: none;" onclick="mostrarPago()">
                        üí≥ Proceder al Pago
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pago -->
    <div id="modalPago" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="flex-between mb-3">
                <h2 style="color: var(--dark);">üí≥ Finalizar Compra</h2>
                <button onclick="cerrarPago()" style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">‚úñÔ∏è</button>
            </div>

            <form id="pagoForm">
                <div class="form-group">
                    <label for="direccion" class="form-label">Direcci√≥n de Env√≠o *</label>
                    <textarea 
                        id="direccion" 
                        class="form-input" 
                        rows="3"
                        placeholder="Calle, n√∫mero, ciudad, c√≥digo postal"
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">M√©todo de Pago *</label>
                    <select id="metodoPago" class="form-input" required>
                        <option value="">Seleccionar m√©todo</option>
                        <option value="tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</option>
                        <option value="pse">üè¶ PSE</option>
                        <option value="efectivo">üíµ Efectivo (Contra entrega)</option>
                    </select>
                </div>

                <div id="datosTarjeta" style="display: none;">
                    <div class="form-group">
                        <label for="numeroTarjeta" class="form-label">N√∫mero de Tarjeta</label>
                        <input 
                            type="text" 
                            id="numeroTarjeta" 
                            class="form-input" 
                            placeholder="1234 5678 9012 3456"
                            maxlength="19"
                        >
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="expiracion" class="form-label">Vencimiento</label>
                            <input 
                                type="text" 
                                id="expiracion" 
                                class="form-input" 
                                placeholder="MM/AA"
                                maxlength="5"
                            >
                        </div>
                        <div class="form-group">
                            <label for="cvv" class="form-label">CVV</label>
                            <input 
                                type="text" 
                                id="cvv" 
                                class="form-input" 
                                placeholder="123"
                                maxlength="4"
                            >
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mb-3">
                    ‚ö†Ô∏è <strong>Modo Simulaci√≥n:</strong> Esta es una pasarela de pago simulada. No se realizar√°n cargos reales.
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block" id="btnConfirmarPago">
                        ‚úÖ Confirmar Pedido - $<span id="totalPago">0</span>
                    </button>
                    <button type="button" class="btn btn-secondary btn-block" onclick="cerrarPago()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let carrito = [];

        // Verificar sesi√≥n
        async function verificarSesion() {
            try {
                const response = await fetch('/api/sesion');
                const data = await response.json();
                
                if (!data.autenticado) {
                    window.location.href = 'login.html';
                    return;
                }
                
                cargarCarrito();
            } catch (error) {
                console.error('Error:', error);
                window.location.href = 'login.html';
            }
        }

        // Cargar carrito
        async function cargarCarrito() {
            const loading = document.getElementById('loading');
            const carritoVacio = document.getElementById('carritoVacio');
            const carritoItems = document.getElementById('carritoItems');
            const btnProceder = document.getElementById('btnProcederPago');

            try {
                const response = await fetch('/api/carrito');
                const data = await response.json();

                loading.style.display = 'none';
                carrito = data.items;

                if (carrito.length === 0) {
                    carritoVacio.style.display = 'block';
                    btnProceder.style.display = 'none';
                    document.getElementById('cartCount').textContent = '0';
                    return;
                }

                btnProceder.style.display = 'block';
                carritoItems.innerHTML = carrito.map(item => `
                    <div class="cart-item">
                        <img src="${item.imagen || 'https://via.placeholder.com/100'}" alt="${item.nombre}" class="cart-item-image">
                        <div class="cart-item-info">
                            <h4 style="color: var(--dark); margin-bottom: 0.5rem;">${item.nombre}</h4>
                            <p style="color: var(--primary); font-weight: 600; font-size: 1.2rem;">$${formatearPrecio(item.precio)}</p>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button class="quantity-btn" onclick="actualizarCantidad(${item.id_carrito}, ${item.cantidad - 1})">-</button>
                                <span class="quantity-value">${item.cantidad}</span>
                                <button class="quantity-btn" onclick="actualizarCantidad(${item.id_carrito}, ${item.cantidad + 1})">+</button>
                            </div>
                            <button class="btn btn-danger btn-small" onclick="eliminarItem(${item.id_carrito})">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');

                actualizarTotales(data.total);
                document.getElementById('cartCount').textContent = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            } catch (error) {
                console.error('Error al cargar carrito:', error);
                loading.style.display = 'none';
                mostrarAlerta('Error al cargar carrito', 'error');
            }
        }

        // Actualizar cantidad
        async function actualizarCantidad(id_carrito, nuevaCantidad) {
            if (nuevaCantidad < 1) {
                eliminarItem(id_carrito);
                return;
            }

            try {
                const response = await fetch(`/api/carrito/${id_carrito}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cantidad: nuevaCantidad })
                });

                if (response.ok) {
                    cargarCarrito();
                } else {
                    mostrarAlerta('Error al actualizar cantidad', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error de conexi√≥n', 'error');
            }
        }

        // Eliminar item
        async function eliminarItem(id_carrito) {
            if (!confirm('¬øEliminar este producto del carrito?')) return;

            try {
                const response = await fetch(`/api/carrito/${id_carrito}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    mostrarAlerta('‚úÖ Producto eliminado', 'success');
                    cargarCarrito();
                } else {
                    mostrarAlerta('Error al eliminar producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error de conexi√≥n', 'error');
            }
        }

        // Actualizar totales
        function actualizarTotales(total) {
            document.getElementById('subtotal').textContent = formatearPrecio(total);
            document.getElementById('total').textContent = formatearPrecio(total);
            document.getElementById('totalPago').textContent = formatearPrecio(total);
        }

        // Mostrar modal de pago
        function mostrarPago() {
            document.getElementById('modalPago').style.display = 'flex';
        }

        function cerrarPago() {
            document.getElementById('modalPago').style.display = 'none';
            document.getElementById('pagoForm').reset();
            document.getElementById('datosTarjeta').style.display = 'none';
        }

        // Mostrar campos seg√∫n m√©todo de pago
        document.getElementById('metodoPago').addEventListener('change', function() {
            const datosTarjeta = document.getElementById('datosTarjeta');
            if (this.value === 'tarjeta') {
                datosTarjeta.style.display = 'block';
                document.getElementById('numeroTarjeta').required = true;
                document.getElementById('expiracion').required = true;
                document.getElementById('cvv').required = true;
            } else {
                datosTarjeta.style.display = 'none';
                document.getElementById('numeroTarjeta').required = false;
                document.getElementById('expiracion').required = false;
                document.getElementById('cvv').required = false;
            }
        });

        // Formatear n√∫mero de tarjeta
        document.getElementById('numeroTarjeta').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Formatear expiraci√≥n
        document.getElementById('expiracion').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Procesar pago
        document.getElementById('pagoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const direccion = document.getElementById('direccion').value.trim();
            const metodoPago = document.getElementById('metodoPago').value;

            if (!direccion || !metodoPago) {
                mostrarAlerta('Por favor completa todos los campos requeridos', 'error');
                return;
            }

            const btnConfirmar = document.getElementById('btnConfirmarPago');
            btnConfirmar.disabled = true;
            btnConfirmar.textContent = 'Procesando...';

            try {
                const response = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        direccion_envio: direccion,
                        metodo_pago: metodoPago
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    cerrarPago();
                    mostrarAlerta('‚úÖ ¬°Pedido creado exitosamente!', 'success');
                    setTimeout(() => {
                        window.location.href = `factura.html?pedido=${data.id_pedido}`;
                    }, 1500);
                } else {
                    mostrarAlerta(data.error || 'Error al procesar el pedido', 'error');
                    btnConfirmar.disabled = false;
                    btnConfirmar.textContent = '‚úÖ Confirmar Pedido - 
             + document.getElementById('total').textContent;
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error de conexi√≥n', 'error');
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = '‚úÖ Confirmar Pedido - 
             + document.getElementById('total').textContent;
            }
        });

        // Cerrar sesi√≥n
        document.getElementById('btnLogout').addEventListener('click', async (e) => {
            e.preventDefault();
            if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error al cerrar sesi√≥n:', error);
                }
            }
        });

        function formatearPrecio(precio) {
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(precio);
        }

        function mostrarAlerta(mensaje, tipo = 'error') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${tipo}">
                    ${mensaje}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 3000);
        }

        // Inicializar
        verificarSesion();